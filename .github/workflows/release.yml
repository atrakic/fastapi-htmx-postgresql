name: Release Helm Chart
on:
  push:
    #branches:
    #  - "releases/*"
    # Publish `v1.2.3` tags as releases.
    tags:
    - 'v*'

permissions:
  contents: write # needed to write releases
  id-token: write # needed for keyless signing
  packages: write # needed for ghcr access

env:
  HELM_CHART: fastapi-htmx-postgresql 
  CHART_URL: https://atrakic.github.io/helm-charts/

jobs:
  release:
    name: "Release"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}

      - uses: sigstore/cosign-installer@main

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Prepare
        id: prep
        run: |
          VERSION=sha-${GITHUB_SHA::8}
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF/refs\/tags\//}
          fi
          echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION:1}" >> $GITHUB_OUTPUT   # Strip "v" prefix from tag name
          echo "REVISION=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          #echo "CURR_VERSION=$(cat charts/fastapi-htmx-postgresql/Chart.yaml | grep ^version | head -1 | awk -F: '{ print $2 }' | sed 's/[\",]//g' | tr -d '[[:space:]]'" >> $GITHUB_OUTPUT

      - name: Log in to registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin

      - name: Publish Helm chart to GHCR
        run: |
          set -ex
          helm package charts/${{ env.HELM_CHART }}
          helm push ${{ env.HELM_CHART }}-${{ steps.prep.outputs.VERSION }}.tgz oci://ghcr.io/${{ github.repository_owner }}/charts
          rm -rf ${{ env.HELM_CHART }}-${{ steps.prep.outputs.VERSION }}.tgz

      - name: Sign OCI artifacts
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          cosign sign ghcr.io/${{ github.repository_owner }}/charts/${{ env.HELM_CHART }}:${{ steps.prep.outputs.VERSION }}

      - name: Publish Helm chart
        uses: stefanprodan/helm-gh-pages@master
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # ${{ secrets.BOT_GITHUB_TOKEN }}
          charts_dir: charts
          charts_url: ${{ env.CHART_URL }}
          owner: ${{ github.repository_owner }}
          repository: helm-charts
          branch: gh-pages
          target_dir: charts
          #commit_username: "$GITHUB_ACTOR"
          #commit_email: "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Confirm helm repo listings
        run: |
          helm repo add "${{ github.repository_owner }}" "https://${{ github.repository_owner }}.github.io/helm-charts/"
          helm repo update
          helm search repo "${{ github.repository_owner }}"
